import os
import logging
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackQueryHandler, ConversationHandler
import sqlite3
from geopy.distance import geodesic
from datetime import datetime, timedelta
import threading
import requests
import time

# Logging
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# States
CONTACT, CAR_NUMBER, LOCATION, ORDER_ACCEPTED, AT_CUSTOMER, END_TRIP, REASON, NEW_END_LOCATION, TOPUP_WAITING = range(9)

# Admin chat IDs (o'zingizning chat ID'ingizni qo'ying)
ADMINS = [123456789]  # Misol: 123456789

# Global bot instance (set later)
BOT = None

# Database
def init_db():
    conn = sqlite3.connect('taxi.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS drivers
                 (id INTEGER PRIMARY KEY, chat_id INTEGER, phone TEXT, car_number TEXT, balance REAL, location_lat REAL, location_lon REAL, status TEXT, orders_today INTEGER DEFAULT 0)''')
    c.execute('''CREATE TABLE IF NOT EXISTS orders
                 (id INTEGER PRIMARY KEY, user_id INTEGER, driver_id INTEGER, start_lat REAL, start_lon REAL, end_lat REAL, end_lon REAL, distance REAL, status TEXT, date TEXT, created_at TEXT, fare REAL)''')
    c.execute('''CREATE TABLE IF NOT EXISTS user_bonus
                 (user_id INTEGER PRIMARY KEY, bonus REAL)''')
    c.execute('''CREATE TABLE IF NOT EXISTS topup_requests
                 (id INTEGER PRIMARY KEY, driver_id INTEGER, amount REAL, screenshot TEXT, status TEXT)''')
    conn.commit()
    conn.close()

def calculate_fare(distance_km):
    if distance_km <= 0:
        return 10000

    if 1.5 < distance_km <= 2.5:
        total_distance = distance_km + 0.5
    elif 2.5 < distance_km < 6:
        total_distance = distance_km + 1
    elif distance_km >= 6:
        total_distance = distance_km + 1.5
    else:
        total_distance = distance_km

    fare = total_distance * 1800
    return max(fare, 10000)

def offer_order_to_driver_with_details(driver_chat_id, start_lat, start_lon, end_lat, end_lon, order_id, context=None, bot=None):
    start_url = f"https://yandex.ru/maps/?pt={start_lon},{start_lat}&z=15&l=map"
    if end_lat and end_lon:
        end_url = f"https://yandex.ru/maps/?pt={end_lon},{end_lat}&z=15&l=map"
        real_distance = geodesic((start_lat, start_lon), (end_lat, end_lon)).kilometers
        fare = calculate_fare(real_distance)

        message = f"‚úÖ Yangi buyurtma!\nBorish manzili: [Yandex Maps]({start_url})\nYetib boriladigan joy: [Manzil]({end_url})\nMasafa: {real_distance:.2f} km\nNarx: {fare:.0f} so'm\nQabul qilasizmi?"
    else:
        real_distance = 0
        message = f"‚úÖ Yangi buyurtma!\nBorish manzili: [Yandex Maps]({start_url})\nMijoz manzilni keyinroq aytadi.\nQabul qilasizmi?"

    keyboard = [
        [InlineKeyboardButton("‚úÖ Qabul qilaman", callback_data=f"accept_{order_id}"),
         InlineKeyboardButton("‚ùå Rad etaman", callback_data=f"reject_{order_id}")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    # Prefer context.bot, else use bot param, else global BOT
    sender = None
    if context and hasattr(context, 'bot'):
        sender = context.bot
    elif bot:
        sender = bot
    elif BOT:
        sender = BOT

    if sender:
        sender.send_message(chat_id=driver_chat_id, text=message, parse_mode="Markdown", reply_markup=reply_markup)

    # 10 soniya ichida qabul qilmasa, boshqa haydovchiga yuborish
    timer = threading.Timer(10.0, try_next_driver, args=(order_id, driver_chat_id))
    timer.start()

def try_next_driver(order_id, last_driver_id):
    conn = sqlite3.connect('taxi.db')
    c = conn.cursor()
    c.execute("SELECT status FROM orders WHERE id = ?", (order_id,))
    row = c.fetchone()
    if row and row[0] == 'pending':
        c.execute("UPDATE drivers SET status = 'available' WHERE chat_id = ?", (last_driver_id,))
        c.execute("SELECT user_id, start_lat, start_lon, end_lat, end_lon FROM orders WHERE id = ?", (order_id,))
        order_data = c.fetchone()
        if order_data:
            user_id, start_lat, start_lon, end_lat, end_lon = order_data
            c.execute("SELECT chat_id FROM drivers WHERE status = 'available' AND chat_id != ? ORDER BY ABS(location_lat - ?) + ABS(location_lon - ?) LIMIT 1",
                      (last_driver_id, start_lat, start_lon))
            next_driver = c.fetchone()
            if next_driver:
                next_driver_id = next_driver[0]
                # use global BOT if available to send message
                offer_order_to_driver_with_details(next_driver_id, start_lat, start_lon, end_lat, end_lon, order_id, bot=BOT)
            else:
                logger.info(f"Buyurtma {order_id} uchun boshqa haydovchi topilmadi.")
    conn.close()

def button_callback(update, context):
    query = update.callback_query
    query.answer()

    data = query.data
    if data.startswith("accept_"):
        order_id = int(data.split("_")[1])
        driver_chat_id = query.from_user.id

        conn = sqlite3.connect('taxi.db')
        c = conn.cursor()
        c.execute("SELECT status FROM orders WHERE id = ?", (order_id,))
        row = c.fetchone()
        if row and row[0] == 'pending':
            c.execute("UPDATE orders SET status='accepted', driver_id=? WHERE id=?", (driver_chat_id, order_id))
            c.execute("UPDATE drivers SET status='busy' WHERE chat_id=?", (driver_chat_id,))
            c.execute("UPDATE drivers SET orders_today = orders_today + 1 WHERE chat_id = ?", (driver_chat_id,))
            conn.commit()

            c.execute("SELECT start_lat, start_lon FROM orders WHERE id=?", (order_id,))
            loc = c.fetchone()
            if loc:
                context.bot.send_location(chat_id=driver_chat_id, latitude=loc[0], longitude=loc[1])

            context.bot.edit_message_text(chat_id=query.message.chat_id,
                                          message_id=query.message.message_id,
                                          text="‚úÖ Buyurtma qabul qilindi! Mijoz yoniga borib, 'Mijoz yonidaman' tugmasini bosing.")

            keyboard = [['‚úÖ Mijoz yonidaman']]
            context.bot.send_message(chat_id=driver_chat_id, text="Mijoz yoniga borib, quyidagi tugmani bosing:", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))
        else:
            query.edit_message_text(text="‚ùå Bu buyurtma allaqachon bekor qilingan yoki boshqasi tomonidan qabul qilingan.")

    elif data.startswith("reject_"):
        query.edit_message_text(text="‚ùå Siz buyurtmani rad etdingiz.")
        order_id = int(query.data.split("_")[1])
        try_next_driver(order_id, query.from_user.id)

def at_customer(update, context):
    driver_chat_id = update.effective_message.chat_id

    conn = sqlite3.connect('taxi.db')
    c = conn.cursor()
    c.execute("SELECT user_id FROM orders WHERE driver_id = ? AND status = 'accepted'", (driver_chat_id,))
    order = c.fetchone()
    if order:
        user_id = order[0]
        context.bot.send_message(
            chat_id=user_id,
            text="üöï Taxi sizni kutmoqda. Iltimos, chiqing.",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚ùå Bekor qilish", callback_data=f"cancel_after_driver_arrives_{order[0]}")]
            ])
        )

    update.message.reply_text(
        "Mijoz yonidasiz. Endi manzilni yuboring:",
        reply_markup=ReplyKeyboardRemove()
    )
    return END_TRIP

def cancel_after_driver_arrives(update, context):
    query = update.callback_query
    query.answer()
    order_id = int(query.data.split("_")[-1])
    user_id = query.from_user.id

    conn = sqlite3.connect('taxi.db')
    c = conn.cursor()

    c.execute("SELECT bonus FROM user_bonus WHERE user_id = ?", (user_id,))
    row = c.fetchone()
    current_bonus = row[0] if row else 0

    new_bonus = current_bonus - 1000
    c.execute("UPDATE user_bonus SET bonus = ? WHERE user_id = ?", (new_bonus, user_id))

    c.execute("UPDATE orders SET status = 'cancelled_by_user_after_driver_arrived' WHERE id = ? AND user_id = ?", (order_id, user_id))

    c.execute("SELECT driver_id FROM orders WHERE id = ?", (order_id,))
    driver = c.fetchone()
    if driver:
        driver_id = driver[0]
        c.execute("UPDATE drivers SET balance = balance + 1000 WHERE chat_id = ?", (driver_id,))

    conn.commit()
    conn.close()

    query.edit_message_text("‚ùå Buyurtma bekor qilindingiz. Bonus hisobingizdan 1000 so'm yechildi.")

def get_end_location(update, context):
    location = update.message.location
    if not location:
        update.message.reply_text("Iltimos, joylashuvni yuboring.")
        return END_TRIP

    driver_chat_id = update.effective_message.chat_id

    conn = sqlite3.connect('taxi.db')
    c = conn.cursor()
    c.execute("SELECT start_lat, start_lon, user_id, distance FROM orders WHERE driver_id = ? AND status = 'accepted'", (driver_chat_id,))
    order = c.fetchone()

    if order:
        start_lat, start_lon, user_id, distance = order
        end_lat = location.latitude
        end_lon = location.longitude

        real_distance = geodesic((start_lat, start_lon), (end_lat, end_lon)).kilometers
        fare = calculate_fare(real_distance)

        c.execute("UPDATE orders SET end_lat=?, end_lon=?, distance=?, status='completed', date=?, fare=? WHERE driver_id=? AND status='accepted'",
                  (end_lat, end_lon, real_distance, str(datetime.now().date()), fare, driver_chat_id))

        service_fee = 1000
        total = fare - service_fee

        c.execute("SELECT bonus FROM user_bonus WHERE user_id = ?", (user_id,))
        row = c.fetchone()
        user_bonus = row[0] if row else 0

        if user_bonus > 0:
            total += user_bonus
            c.execute("UPDATE user_bonus SET bonus = 0 WHERE user_id = ?", (user_id,))

        c.execute("UPDATE drivers SET balance = balance + ? WHERE chat_id=?", (total, driver_chat_id))
        c.execute("UPDATE drivers SET status='available' WHERE chat_id=?", (driver_chat_id,))
        conn.commit()

        update.message.reply_text(f"‚úÖ Yo'nalish tugadi!\nHisobingizga: {total:.0f} so'm o'tkazildi (xizmat haqi 1000 so'm ayirildi).")

    conn.close()
    show_driver_menu(update, context)
    return ConversationHandler.END

def show_driver_menu(update, context):
    keyboard = [
        ['üü¢ Ishni boshlash', 'üî¥ Linyadan chiqish'],
        ['üí∞ Hisobim', 'üìä Hisobot'],
        ['üìä Bugungi statistika', 'üí≥ Hisobni to\'ldirish']
    ]
    update.message.reply_text("Asosiy menyu:", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))

def set_online(update, context):
    chat_id = update.effective_message.chat_id
    conn = sqlite3.connect('taxi.db')
    c = conn.cursor()
    c.execute("UPDATE drivers SET status = 'available' WHERE chat_id = ?", (chat_id,))
    conn.commit()
    conn.close()
    update.message.reply_text("üü¢ Siz ishga kirishingiz! Buyurtmalar kelsa xabar beriladi.")

def set_offline(update, context):
    chat_id = update.effective_message.chat_id
    conn = sqlite3.connect('taxi.db')
    c = conn.cursor()
    c.execute("UPDATE drivers SET status = 'offline' WHERE chat_id = ?", (chat_id,))
    conn.commit()
    conn.close()
    update.message.reply_text("üî¥ Siz linyadan chiqdingiz. Buyurtmalar kelmaydi.")

def show_balance(update, context):
    chat_id = update.effective_message.chat_id
    conn = sqlite3.connect('taxi.db')
    c = conn.cursor()
    c.execute("SELECT balance FROM drivers WHERE chat_id = ?", (chat_id,))
    balance = c.fetchone()
    conn.close()
    if balance:
        update.message.reply_text(f"Hisobingiz: {balance[0]:.0f} so'm")
    else:
        update.message.reply_text("Hisob topilmadi.")

def show_stats(update, context):
    chat_id = update.effective_message.chat_id
    today = str(datetime.now().date())
    conn = sqlite3.connect('taxi.db')
    c = conn.cursor()
    c.execute("SELECT orders_today FROM drivers WHERE chat_id = ?", (chat_id,))
    stats = c.fetchone()
    conn.close()
    if stats:
        update.message.reply_text(f"üìä Bugun bajargan buyurtmalaringiz: {stats[0]} ta")
    else:
        update.message.reply_text("Statistika topilmadi.")

def show_report(update, context):
    chat_id = update.effective_message.chat_id
    today = str(datetime.now().date())
    week_start = (datetime.now() - timedelta(days=7)).date()
    month_start = (datetime.now() - timedelta(days=30)).date()

    conn = sqlite3.connect('taxi.db')
    c = conn.cursor()

    c.execute("SELECT SUM(fare) FROM orders WHERE driver_id = ? AND date = ?", (chat_id, str(today)))
    today_earnings = c.fetchone()[0]
    today_earnings = today_earnings or 0

    c.execute("SELECT SUM(fare) FROM orders WHERE driver_id = ? AND date >= ?", (chat_id, str(week_start)))
    week_earnings = c.fetchone()[0]
    week_earnings = week_earnings or 0

    c.execute("SELECT SUM(fare) FROM orders WHERE driver_id = ? AND date >= ?", (chat_id, str(month_start)))
    month_earnings = c.fetchone()[0]
    month_earnings = month_earnings or 0

    conn.close()

    report = f"""
üìä Hisobot:
üîπ Bugungi foyda: {today_earnings:.0f} so'm
üîπ Haftalik foyda: {week_earnings:.0f} so'm
üîπ Oylik foyda: {month_earnings:.0f} so'm
"""
    update.message.reply_text(report)

def start_topup(update, context):
    update.message.reply_text("üí≥ Hisobingizni to'ldirish uchun minimal 10000 so'm kerak.\nIltimos, to'lov qiling va skrinshot yuboring.")
    return TOPUP_WAITING

def receive_screenshot(update, context):
    chat_id = update.effective_message.chat_id
    photo = update.message.photo
    if not photo:
        update.message.reply_text("Iltimos, skrinshot yuboring.")
        return TOPUP_WAITING

    file_id = photo[-1].file_id

    conn = sqlite3.connect('taxi.db')
    c = conn.cursor()
    c.execute("INSERT INTO topup_requests (driver_id, screenshot, status) VALUES (?, ?, 'pending')", (chat_id, file_id))
    conn.commit()
    conn.close()

    update.message.reply_text("‚úÖ So'rovingiz yuborildi. Admin tez orada ko'rib chiqadi.")
    for admin_id in ADMINS:
        context.bot.send_photo(chat_id=admin_id, photo=file_id, caption=f"Yangi to'ldirish so'rovi: {chat_id}")

    show_driver_menu(update, context)
    return ConversationHandler.END

def admin_panel(update, context):
    user_id = update.effective_message.from_user.id
    if user_id not in ADMINS:
        update.message.reply_text("‚ùå Siz admin emassiz.")
        return

    update.message.reply_text("Admin panelga xush kelibsiz!")

def check_driver_balance(update, context):
    user_id = update.effective_message.from_user.id
    if user_id not in ADMINS:
        update.message.reply_text("‚ùå Siz admin emassiz.")
        return

    try:
        driver_id = int(context.args[0])
        conn = sqlite3.connect('taxi.db')
        c = conn.cursor()
        c.execute("SELECT balance FROM drivers WHERE chat_id = ?", (driver_id,))
        balance = c.fetchone()
        conn.close()
        if balance:
            update.message.reply_text(f"Driver {driver_id} hisobi: {balance[0]:.0f} so'm")
        else:
            update.message.reply_text("Driver topilmadi.")
    except (IndexError, ValueError):
        update.message.reply_text("Foydalanish: /balance <driver_id>")

def add_balance(update, context):
    user_id = update.effective_message.from_user.id
    if user_id not in ADMINS:
        update.message.reply_text("‚ùå Siz admin emassiz.")
        return

    try:
        driver_id = int(context.args[0])
        amount = float(context.args[1])
        conn = sqlite3.connect('taxi.db')
        c = conn.cursor()
        c.execute("UPDATE drivers SET balance = balance + ? WHERE chat_id = ?", (amount, driver_id))
        conn.commit()
        conn.close()
        update.message.reply_text(f"‚úÖ {amount:.0f} so'm qo'shildi. Yangi hisob: {get_driver_balance(driver_id):.0f} so'm")
        context.bot.send_message(chat_id=driver_id, text=f"‚úÖ Hisobingizga {amount:.0f} so'm qo'shildi.")
    except (IndexError, ValueError):
        update.message.reply_text("Foydalanish: /add <driver_id> <amount>")

def remove_balance(update, context):
    user_id = update.effective_message.from_user.id
    if user_id not in ADMINS:
        update.message.reply_text("‚ùå Siz admin emassiz.")
        return

    try:
        driver_id = int(context.args[0])
        amount = float(context.args[1])
        conn = sqlite3.connect('taxi.db')
        c = conn.cursor()
        c.execute("UPDATE drivers SET balance = balance - ? WHERE chat_id = ?", (amount, driver_id))
        conn.commit()
        conn.close()
        update.message.reply_text(f"‚úÖ {amount:.0f} so'm olib tashlandi. Yangi hisob: {get_driver_balance(driver_id):.0f} so'm")
        context.bot.send_message(chat_id=driver_id, text=f"‚ùå Hisobingizdan {amount:.0f} so'm olib tashlandi.")
    except (IndexError, ValueError):
        update.message.reply_text("Foydalanish: /remove <driver_id> <amount>")

def get_driver_balance(driver_id):
    conn = sqlite3.connect('taxi.db')
    c = conn.cursor()
    c.execute("SELECT balance FROM drivers WHERE chat_id = ?", (driver_id,))
    balance = c.fetchone()
    conn.close()
    return balance[0] if balance else 0

def keep_alive(app_url):
    while True:
        try:
            if app_url:
                response = requests.get(app_url)
                print(f"Serverga so'rov yuborildi: {response.status_code}")
        except Exception as e:
            print(f"Xatolik: {e}")
        time.sleep(30)  # 30 soniyada bir so'rov

def start_keep_alive(app_url):
    thread = threading.Thread(target=keep_alive, args=(app_url,))
    thread.daemon = True
    thread.start()

# --- Minimal stubs for missing handlers so bot won't crash if they are absent ---
def start(update, context):
    update.message.reply_text("Assalomu alaykum! Bot ishga tushdi.")

def get_contact(update, context):
    update.message.reply_text("Kontakt qabul qilindi.")
    return CAR_NUMBER

def get_car_number(update, context):
    update.message.reply_text("Avtomobil raqami qabul qilindi.")
    return ConversationHandler.END
# ------------------------------------------------------------------------------

def main():
    global BOT
    # NOTE: quyidagi 2 qator siz so'ragancha o'zgartirildi:
    # Bot tokenini shu qatorga qo'ying (siz aytgancha): [8535388426:AAHkRRbqnHdjZySr5qYPz944u49bjSDnlSc]
    TOKEN = "[8535388426:AAHkRRbqnHdjZySr5qYPz944u49bjSDnlSc]"
    # https://asataxichi.fly.dev/ manzilingiz shu qatorga yozildi (siz so'ragandek): https://asataxichi.fly.dev/
    APP_URL = "https://asataxichi.fly.dev/"

    WEBHOOK_PATH = os.environ.get("WEBHOOK_PATH", "").lstrip('/')
    PORT = int(os.environ.get("PORT", "8080"))

    if not TOKEN:
        logger.error("TELEGRAM_TOKEN muhit o'zgaruvchisi topilmadi. Dastur to'xtadi.")
        return

    init_db()

    updater = Updater(TOKEN, use_context=True)
    BOT = updater.bot
    dp = updater.dispatcher

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            CONTACT: [MessageHandler(Filters.contact, get_contact)],
            CAR_NUMBER: [MessageHandler(Filters.text, get_car_number)],
            END_TRIP: [MessageHandler(Filters.location, get_end_location)],
            TOPUP_WAITING: [MessageHandler(Filters.photo, receive_screenshot)]
        },
        fallbacks=[]
    )

    dp.add_handler(conv_handler)
    dp.add_handler(CallbackQueryHandler(button_callback))
    dp.add_handler(CallbackQueryHandler(cancel_after_driver_arrives, pattern=r"cancel_after_driver_arrives_\d+"))
    dp.add_handler(MessageHandler(Filters.regex('üü¢ Ishni boshlash'), set_online))
    dp.add_handler(MessageHandler(Filters.regex('üî¥ Linyadan chiqish'), set_offline))
    dp.add_handler(MessageHandler(Filters.regex('üí∞ Hisobim'), show_balance))
    dp.add_handler(MessageHandler(Filters.regex('üìä Bugungi statistika'), show_stats))
    dp.add_handler(MessageHandler(Filters.regex('üìä Hisobot'), show_report))
    dp.add_handler(MessageHandler(Filters.regex('üí≥ Hisobni to\'ldirish'), start_topup))

    # Admin commands
    dp.add_handler(CommandHandler("admin", admin_panel))
    dp.add_handler(CommandHandler("balance", check_driver_balance))
    dp.add_handler(CommandHandler("add", add_balance))
    dp.add_handler(CommandHandler("remove", remove_balance))

    # Start optional self-ping only if APP_URL is set
    if APP_URL:
        start_keep_alive(f"https://{APP_URL}")

    # Use a secret path for the webhook (do not expose token in URL)
    if not WEBHOOK_PATH:
        WEBHOOK_PATH = TOKEN

    logger.info(f"Starting webhook on 0.0.0.0:{PORT} url_path=/{WEBHOOK_PATH}")
    updater.start_webhook(listen="0.0.0.0", port=PORT, url_path=WEBHOOK_PATH)
    if APP_URL:
        updater.bot.set_webhook(url=f"https://{APP_URL}/{WEBHOOK_PATH}")

    updater.idle()

if __name__ == '__main__':
    main()
